{% extends "layout.html" %}

{% block title %}Compare Stocks{% endblock %}

{% block content %}
<h2>🔍 Compare Two Stocks</h2>

<form method="post" class="row g-3 align-items-end mb-4">
  <div class="col-md-2">
    <label for="index_a">Index A</label>
    <select name="index_a" class="form-select" required onchange="this.form.submit()">
      <option value="sp500" {% if index_a == 'sp500' %}selected{% endif %}>S&P 500</option>
      <option value="ftse100" {% if index_a == 'ftse100' %}selected{% endif %}>FTSE 100</option>
    </select>
  </div>
  <div class="col-md-4">
    <label for="stock_a">Stock A</label>
    <select name="stock_a" class="form-select" required>
      {% for symbol in stock_list_a %}
        <option value="{{ symbol }}" {% if stock_a == symbol %}selected{% endif %}>{{ symbol }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <label for="index_b">Index B</label>
    <select name="index_b" class="form-select" required onchange="this.form.submit()">
      <option value="sp500" {% if index_b == 'sp500' %}selected{% endif %}>S&P 500</option>
      <option value="ftse100" {% if index_b == 'ftse100' %}selected{% endif %}>FTSE 100</option>
    </select>
  </div>
  <div class="col-md-3">
    <label for="stock_b">Stock B</label>
    <select name="stock_b" class="form-select" required>
      {% for symbol in stock_list_b %}
        <option value="{{ symbol }}" {% if stock_b == symbol %}selected{% endif %}>{{ symbol }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-1">
    <button type="submit" class="btn btn-primary w-100">Compare</button>
  </div>
</form>

{% if stock_a and stock_b %}
<h4>📊 Fundamental Comparison</h4>
<table class="table table-bordered table-hover">
  <thead class="table-light">
    <tr>
      <th>Indicator</th>
      <th>{{ stock_a }}</th>
      <th>{{ stock_b }}</th>
    </tr>
  </thead>
  <tbody>
    {% for label, reverse in indicators %}
      <tr>
        <td>{{ label }}</td>
        <td>{{ fundamentals_a.get(label, 'N/A') }} {% if compare_values(fundamentals_a.get(label), fundamentals_b.get(label), reverse) == '✅' %}✅{% endif %}</td>
        <td>{{ fundamentals_b.get(label, 'N/A') }} {% if compare_values(fundamentals_b.get(label), fundamentals_a.get(label), reverse) == '✅' %}✅{% endif %}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<h4 class="mt-4">📈 TradingView Charts</h4>
<div class="row">
  <div class="col-md-6">
    <h6 class="text-center">{{ stock_a }}</h6>
    <div id="tv-widget-a"></div>
  </div>
  <div class="col-md-6">
    <h6 class="text-center">{{ stock_b }}</h6>
    <div id="tv-widget-b"></div>
  </div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
  function loadTradingViewWidget(containerId, symbol) {
    new TradingView.widget({
      "container_id": containerId,
      "symbol": symbol,
      "interval": "D",
      "timezone": "Etc/UTC",
      "theme": "light",
      "style": "1",
      "locale": "en",
      "width": "100%",
      "height": 400,
      "hide_top_toolbar": true
    });
  }

  loadTradingViewWidget("tv-widget-a", "{{ raw_symbol_a }}");
  loadTradingViewWidget("tv-widget-b", "{{ raw_symbol_b }}");
</script>


{% endif %}

{% endblock %}
